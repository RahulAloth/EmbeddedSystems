# SPI (Serial Peripheral Interface)
### Complete Engineering Guide in Markdown Format

SPI is a high‑speed, synchronous, full‑duplex serial communication protocol widely used in embedded systems.  
It connects microcontrollers to sensors, displays, flash memory, ADC/DACs, and other peripherals.

---

# 1. SPI Bus Lines (The 4 Wires)

SPI uses **four primary signals**:

| Line | Direction | Description |
|------|-----------|-------------|
| **SCLK / SCK** | Master → Slave | Serial clock generated by master |
| **MOSI** | Master → Slave | Master Out, Slave In |
| **MISO** | Slave → Master | Master In, Slave Out |
| **CS / SS** | Master → Slave | Chip Select (active low) |

---

## 1.1 SCLK / SCK — Serial Clock

- Generated **only by the master**  
- Controls when data is shifted and sampled  
- Clock polarity (CPOL) defines idle level  
- Clock phase (CPHA) defines sampling edge  
- If SCLK stops, communication stops

---

## 1.2 MOSI — Master Out, Slave In

- Data line from **master → slave**  
- Used for commands, register addresses, and write data  
- Only the master drives MOSI  
- Slaves read MOSI only when **CS = 0**

---

## 1.3 MISO — Master In, Slave Out

- Data line from **slave → master**  
- Used for reading registers or sensor data  
- Only the selected slave drives MISO  
- All other slaves must **tri‑state** their MISO pins  
- Prevents bus contention

---

## 1.4 CS / SS — Chip Select / Slave Select

- Active‑low signal  
- **CS = 0 → slave active**  
- **CS = 1 → slave inactive**  
- Defines transaction boundaries  
- Each slave typically has its own CS line

---

# 2. SPI Modes (CPOL & CPHA)

SPI has **four modes**, determined by:

- **CPOL** — Clock Polarity  
- **CPHA** — Clock Phase  

| Mode | CPOL | CPHA | Clock Idle | Sample Edge |
|------|------|-------|-------------|--------------|
| 0 | 0 | 0 | Low | Rising |
| 1 | 0 | 1 | Low | Falling |
| 2 | 1 | 0 | High | Falling |
| 3 | 1 | 1 | High | Rising |

Devices must use the **same mode** or communication fails.

---

# 3. SPI Data Transfer

SPI is **full‑duplex**:

- Master shifts data out on MOSI  
- Slave shifts data out on MISO  
- One bit per clock edge  

### Example timing:

```
CS   : 0___________________________1
SCLK : /‾\/‾\/‾\/‾\/‾\/‾\/‾\
MOSI :  M7 M6 M5 M4 M3 M2 M1 M0
MISO :  S7 S6 S5 S4 S3 S2 S1 S0
```


---

# 4. Multi‑Slave Configurations

### 4.1 Independent CS Lines (Most Common)
```
Master → SCLK, MOSI, MISO
CS1 → Slave 1
CS2 → Slave 2
CS3 → Slave 3
```

### 4.2 Daisy‑Chain
- MISO of one slave feeds MOSI of next  
- Used in LED drivers, shift registers

### 4.3 Shared MISO with Tri‑State
- Only selected slave drives MISO  
- Others float the line

---

# 5. SPI Speed

- Typical: **1–20 MHz**  
- Many MCUs: **50 MHz**  
- High‑performance devices: **100+ MHz**  
- QSPI/OSPI: **hundreds of MHz**

SPI is much faster than I²C because:

- No addressing overhead  
- No ACK/NACK  
- Push‑pull drivers  
- No bus capacitance limitations

---

# 6. SPI Transaction Examples

## 6.1 Write Transaction
```
CS = 0
Send command/address on MOSI
Send data bytes
CS = 1
```

## 6.2 Read Transaction
```
CS = 0
Send read command on MOSI
Send dummy bytes
Slave responds on MISO
CS = 1
```

---

# 7. SPI Variants

- **Microwire** — Simplified SPI  
- **Dual SPI** — 2‑bit data lines  
- **Quad SPI (QSPI)** — 4‑bit data lines  
- **Octal SPI (OSPI)** — 8‑bit data lines  
- **3‑wire SPI** — MOSI/MISO combined

---

# 8. Common SPI Issues

- Wrong CPOL/CPHA mode  
- Incorrect CS timing  
- MISO contention  
- Clock too fast for slave  
- Long wires causing ringing/noise  
- Poor grounding or shielding  

---

# 9. SPI in Embedded C

## 9.1 Transfer a Byte
```c
uint8_t spi_transfer(uint8_t data)
{
    SPI->DR = data;
    while (!(SPI->SR & SPI_SR_RXNE));
    return SPI->DR;
}
```

## 9.2 Write Register
```c
void spi_write_reg(uint8_t reg, uint8_t value)
{
    CS_LOW();
    spi_transfer(reg);
    spi_transfer(value);
    CS_HIGH();
}
```
##  9.3 Read Register
```c
uint8_t spi_read_reg(uint8_t reg)
{
    uint8_t val;
    CS_LOW();
    spi_transfer(reg | 0x80); // read bit
    val = spi_transfer(0xFF); // dummy
    CS_HIGH();
    return val;
}
```
# 10. When to Use SPI

-  Use SPI when you need:
    -  High speed
    -  Full‑duplex
    -  Low latency
    -  Simple protocol
    -  Deterministic timing

-  Avoid SPI when you need:
    -  Long distances
    -  Multi‑master
    -  Many devices without many CS pins
    -  Hot‑plugging or bus arbitration

# 20. Look at the example.
- How to adapt this to real TC49xx code
    - Replace module names and registers
        - QSPI0, GLOBALCON, DATAENTRY, RXEXIT, STATUS → use the exact names from your TC49xx header files.
    - Use iLLD where it makes sense
        - You can wrap IfxQspi_SpiMaster from iLLD instead of touching registers directly, but this skeleton is good for understanding.
    - Configure CPOL/CPHA and baudrate
        - Set them in the BACON/GLOBALCON1 fields according to your slave’s SPI mode.
    - Wire CS either via QSPI hardware CS or GPIO
        - Here I used a GPIO CS for clarity; you can also use QSPI’s own CS lines.
